<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>BrushManager Pro - V2.8.5</title>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4361ee">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/1048/1048953.png">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root { --primary: #4361ee; --success: #2ec4b6; --danger: #f72585; --bg: #f0f2f5; --whatsapp: #25D366; --warning: #ff9f43; --gray: #888; --dark: #2d3436; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); margin: 0; padding: 10px; color: #333; overflow-x: hidden; }
        .card { background: #fff; border-radius: 18px; padding: 20px; box-shadow: 0 8px 20px rgba(0,0,0,0.06); margin-bottom: 15px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; margin-bottom: 15px; }
        .stat-card { background: #ffffff; padding: 15px; border-radius: 15px; text-align: center; border-bottom: 4px solid var(--primary); box-shadow: 0 4px 10px rgba(0,0,0,0.03); }
        .stat-card h4 { margin: 0; font-size: 12px; color: #777; font-weight: 600; }
        .stat-card p { margin: 8px 0 0; font-size: 20px; font-weight: 800; color: var(--primary); }
        
        .whatsapp-float { position: fixed; width: 50px; height: 50px; bottom: 80px; left: 20px; background-color: var(--whatsapp); color: #FFF; border-radius: 50px; text-align: center; font-size: 24px; box-shadow: 2px 2px 10px rgba(0,0,0,0.2); z-index: 1000; display: flex; align-items: center; justify-content: center; text-decoration: none; }
        .chat-toggle { position: fixed; width: 50px; height: 50px; bottom: 20px; left: 20px; background-color: var(--primary); color: #FFF; border-radius: 50px; text-align: center; font-size: 24px; box-shadow: 2px 2px 10px rgba(0,0,0,0.2); z-index: 1000; display: flex; align-items: center; justify-content: center; cursor: pointer; border: none; }
        .unread-badge { position: absolute; top: -10px; right: -5px; background: red; color: white; border-radius: 12px; min-width: 20px; height: 20px; font-size: 11px; display: none; align-items: center; justify-content: center; padding: 0 6px; white-space: nowrap; font-weight: bold; border: 2px solid white; }

        table { width: 100%; border-collapse: collapse; min-width: 600px; background: white; }
        th { background: var(--dark); color: white; padding: 12px; font-size: 13px; border: 1px solid #444; }
        td { padding: 5px; border: 1px solid #ddd; text-align: center; }
        input, select { width: 92%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; outline: none; text-align: center; font-size: 14px; font-family: inherit; }
        
        .btn { padding: 10px 15px; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; color: white; margin: 5px; font-size: 13px; transition: 0.2s; }
        .btn-primary { background: var(--primary); }
        .btn-success { background: var(--success); }
        .btn-danger { background: var(--danger); }
        .btn-json { background: #6c757d; }
        .btn-cloud { background: #0984e3; }

        #chatWindow { position: fixed; bottom: 85px; left: 20px; width: 320px; height: 450px; background: white; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); display: none; flex-direction: column; z-index: 1001; overflow: hidden; }
        #chatHeader { background: var(--primary); color: white; padding: 10px 15px; font-weight: bold; }
        #chatMessages { flex: 1; padding: 15px; overflow-y: auto; background: #f4f7f6; display: flex; flex-direction: column; gap: 8px; }
        .msg { max-width: 80%; padding: 10px 14px; border-radius: 18px; font-size: 13px; word-wrap: break-word; }
        .msg-me { align-self: flex-end; background: var(--primary); color: white; border-bottom-right-radius: 4px; }
        .msg-them { align-self: flex-start; background: #fff; color: #333; border-bottom-left-radius: 4px; }

        .footer-credit { text-align: center; margin-top: 20px; font-size: 12px; color: var(--gray); font-weight: 600; padding: 10px; }

        @media print { .noPrint, .whatsapp-float, .chat-toggle, #chatWindow, .footer-credit { display: none !important; } }
    </style>
</head>
<body>

<audio id="notifSound" src="https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3" preload="auto"></audio>

<a href="https://wa.me/201288761131" class="whatsapp-float noPrint" target="_blank">ğŸ“²</a>
<button class="chat-toggle noPrint" onclick="toggleChat()">
    ğŸ’¬ <span id="unreadBadge" class="unread-badge">0</span>
</button>

<div id="chatWindow">
    <div id="chatHeader">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <span>Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø©</span>
            <span onclick="toggleChat()" style="cursor:pointer; font-size: 20px;">âœ•</span>
        </div>
        <div id="chatRecipientArea"></div>
    </div>
    <div id="chatMessages"></div>
    <div id="chatInputArea" style="padding:10px; display:flex; gap:5px; align-items:center; border-top:1px solid #eee;">
        <input type="text" id="chatMsgInput" placeholder="Ø§ÙƒØªØ¨...">
        <button onclick="sendMsg()" class="btn btn-primary" style="margin:0;">Ø§Ø±Ø³Ù„</button>
    </div>
</div>

<div id="loginBox" class="card" style="max-width:400px; margin:50px auto; text-align:center;">
    <h2 style="color:var(--primary);">ğŸ” BrushManager Pro</h2>
    <input id="username" type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" style="margin-bottom:10px;"><br>
    <input id="pass" type="password" placeholder="Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯" style="margin-bottom:15px;"><br>
    <button onclick="login('user')" class="btn btn-primary" style="width:100%">Ø¯Ø®ÙˆÙ„</button>
    <hr>
    <button onclick="document.getElementById('adminForm').style.display='block'" style="background:none; border:none; color:var(--primary); font-size:12px;">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ ğŸ› </button>
    <div id="adminForm" style="display:none; margin-top:10px;">
        <input id="adminUser" type="text" placeholder="Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„"><br>
        <input id="adminPass" type="password" placeholder="Ø§Ù„ÙƒÙˆØ¯" style="margin-top:5px;"><br>
        <button onclick="login('admin')" class="btn btn-danger" style="width:100%; margin-top:10px;">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</button>
    </div>
    <div class="footer-credit" style="margin-top:15px;">Ø¨Ø±Ù…Ø¬Ø© Ø£. Ù…Ø­Ù…ÙˆØ¯ Ø¨Ø¯ÙŠØ± - Ø¥ØµØ¯Ø§Ø± V2.8.5</div>
</div>

<div id="app" style="display:none;">
    <div class="card noPrint" style="display:flex; justify-content:space-between; align-items:center;">
        <div><span id="connDot" style="width:10px; height:10px; border-radius:50%; display:inline-block;"></span> <span id="connText" style="font-size:11px;"></span></div>
        <div style="font-weight:bold;">ğŸ‘¤ <span id="welcomeUser"></span></div>
        <button onclick="location.reload()" class="btn btn-danger" style="padding:5px 10px;">Ø®Ø±ÙˆØ¬</button>
    </div>

    <div id="adminPanel" class="card noPrint" style="display:none; border:2px solid var(--danger);">
        <h4 style="color:var(--danger); margin-top:0;">ğŸ›  Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†Ø¸Ø§Ù…</h4>
        <div style="display:flex; gap:5px; margin-bottom:10px;">
            <input id="newWorkerName" type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù">
            <input id="newWorkerPass" type="text" placeholder="Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯">
            <button onclick="addNewWorker()" class="btn btn-success">Ø¥Ø¶Ø§ÙØ©</button>
        </div>
        <div id="usersList"></div>
    </div>

    <div class="card noPrint" style="display:flex; gap:10px; flex-wrap:wrap;">
        <div style="flex:1;"><label style="font-size:11px;">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label><select id="userSelect" onchange="switchContext()"></select></div>
        <div style="flex:1;"><label style="font-size:11px;">Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input type="date" id="daySelect" onchange="switchContext()"></div>
        <div style="flex:1;"><label style="font-size:11px;">Ø§Ù„ÙˆØ±Ø¯ÙŠØ©</label>
            <select id="shiftSelect" onchange="switchContext()">
                <option value="ÙˆØ±Ø¯ÙŠØ©_1">Ø§Ù„Ø£ÙˆÙ„Ù‰</option><option value="ÙˆØ±Ø¯ÙŠØ©_2">Ø§Ù„Ø«Ø§Ù†ÙŠØ©</option><option value="ÙˆØ±Ø¯ÙŠØ©_3">Ø§Ù„Ø«Ø§Ù„Ø«Ø©</option>
            </select>
        </div>
    </div>

    <div id="printArea">
        <div class="stats-grid">
            <div class="stat-card"><h4>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚Ø·Ø¹</h4><p id="sumTotal">0</p></div>
            <div class="stat-card"><h4>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù‚Ø§Ø³Ø§Øª</h4><p id="sumSizes">0</p></div>
        </div>
        <div class="card" style="overflow-x:auto;">
            <table id="mainTable">
                <thead><tr><th>Ø§Ù„ÙØ±Ø´Ø©</th><th>Ø§Ù„Ø·Ø¨Ù‚Ø§Øª</th><th>Ø§Ù„Ù…Ù‚Ø§Ø³</th><th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th><th>Ø§Ù„Ø®Ø·</th><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th><th class="noPrint">âœ–</th></tr></thead>
                <tbody id="tbody" oninput="liveUpdate()" onkeyup="liveUpdate()"></tbody>
            </table>
        </div>
    </div>

    <div class="card noPrint" style="text-align:center;">
        <button onclick="addRow()" class="btn btn-success">â• Ø¥Ø¶Ø§ÙØ© Ø³Ø·Ø±</button>
        <button onclick="window.print()" class="btn btn-danger">ğŸ“„ PDF</button>
        <hr>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <div style="border-left:1px solid #eee;">
                <p style="font-size:11px; font-weight:bold;">ğŸ“‚ Ø£ÙˆÙÙ„Ø§ÙŠÙ† (JSON)</p>
                <button onclick="exportJSON()" class="btn btn-json" style="width:90%">ğŸ“¤ ØªØµØ¯ÙŠØ±</button>
                <button onclick="document.getElementById('importFileUser').click()" class="btn btn-json" style="width:90%">ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯</button>
                <input type="file" id="importFileUser" hidden onchange="importJSON(this)">
            </div>
            <div>
                <p style="font-size:11px; font-weight:bold; color:#0984e3;">â˜ï¸ Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† (Firebase)</p>
                <button onclick="cloudBackup()" class="btn btn-cloud" style="width:90%">ğŸ“¤ Ø±ÙØ¹ Ù„Ù„Ø³Ø­Ø§Ø¨Ø©</button>
                <button onclick="cloudRestore()" class="btn btn-cloud" style="width:90%">ğŸ“¥ Ø§Ø³ØªØ¹Ø§Ø¯Ø©</button>
            </div>
        </div>
    </div>
</div>

<script>
// Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase
const firebaseConfig = {
    apiKey: "AIzaSyDDhfiJkDvafZQB57DA9jsF7R3iF8jokQI",
    authDomain: "brushmanager-98d94.firebaseapp.com",
    databaseURL: "https://brushmanager-98d94-default-rtdb.firebaseio.com",
    projectId: "brushmanager-98d94",
    appId: "1:319953455236:web:e7e93bf6073da63f1b1ad1"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let users = {"admin":{"pass":"MTIz","role":"super"}};
let currentUser, activeUser, activeDay, activeShift;
let chatRecipient = "admin";
let isChatOpen = false;

function login(type) {
    let u = (type === 'admin' ? document.getElementById('adminUser') : document.getElementById('username')).value.trim();
    let p = (type === 'admin' ? document.getElementById('adminPass') : document.getElementById('pass')).value;
    db.ref('users').once('value', snap => {
        let all = snap.val() || users;
        if (all[u] && all[u].pass === btoa(p)) { users = all; startSession(u); } 
        else Swal.fire('Ø®Ø·Ø£', 'Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©', 'error');
    });
}

function startSession(u) {
    currentUser = activeUser = u;
    activeDay = new Date().toISOString().split('T')[0];
    activeShift = "ÙˆØ±Ø¯ÙŠØ©_1";
    document.getElementById('loginBox').style.display = 'none';
    document.getElementById('app').style.display = 'block';
    document.getElementById('welcomeUser').innerText = u;
    document.getElementById('daySelect').value = activeDay;
    initApp(); loadContent(); setupChatUI(); listenForNotifications();
}

// --- Ù†Ø¸Ø§Ù… Ø§Ù„Ø³Ø­Ø§Ø¨Ø© Ø§Ù„Ù…Ø·ÙˆØ± ---
async function cloudBackup() {
    Swal.fire({ title: 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¶ÙŠØ± Ù„Ø±ÙØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
    
    try {
        const snap = await db.ref('archive').once('value');
        const allData = snap.val() || {};
        let myArchive = {};
        let hasData = false;

        for (let d in allData) {
            for (let s in allData[d]) {
                if (allData[d][s][currentUser]) {
                    if (!myArchive[d]) myArchive[d] = {};
                    myArchive[d][s] = { [currentUser]: allData[d][s][currentUser] };
                    hasData = true;
                }
            }
        }

        if (!hasData) {
            Swal.fire('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª', 'Ø£Ù†Øª Ù„Ù… ØªÙ‚Ù… Ø¨ØªØ³Ø¬ÙŠÙ„ Ø£ÙŠ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯ Ù„Ø±ÙØ¹Ù‡Ø§', 'info');
            return;
        }

        await db.ref(`backups/${currentUser}`).set({
            data: myArchive,
            lastSync: firebase.database.ServerValue.TIMESTAMP
        });
        
        Swal.fire('Ù†Ø¬Ø§Ø­', 'ØªÙ… Ø­ÙØ¸ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø³Ø­Ø§Ø¨ÙŠØ© Ù„Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„', 'success');
    } catch (err) {
        Swal.fire('Ø®Ø·Ø£', 'Ø­Ø¯Ø«Øª Ù…Ø´ÙƒÙ„Ø© Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø±ÙØ¹: ' + err.message, 'error');
    }
}

async function cloudRestore() {
    const snap = await db.ref(`backups/${currentUser}`).once('value');
    const cloud = snap.val();
    
    if (!cloud || !cloud.data) {
        return Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ø³Ø®Ø© Ø³Ø­Ø§Ø¨ÙŠØ© Ù…Ø­ÙÙˆØ¸Ø© Ù„Ùƒ', 'warning');
    }

    const result = await Swal.fire({
        title: 'Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø³Ø­Ø§Ø¨ÙŠØ©ØŸ',
        text: "Ø³ÙŠØªÙ… Ø¯Ù…Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ© Ù…Ø¹ Ø§Ù„Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ø­Ø§Ù„ÙŠ. Ù‚Ø¯ ÙŠØ¤Ø¯ÙŠ Ù‡Ø°Ø§ Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø³Ø¬Ù„Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹ Ø¨Ù†ÙØ³ Ø§Ù„ØªØ§Ø±ÙŠØ®.",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©',
        cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'
    });

    if (result.isConfirmed) {
        for (let d in cloud.data) {
            for (let s in cloud.data[d]) {
                await db.ref(`archive/${d}/${s}/${currentUser}`).set(cloud.data[d][s][currentUser]);
            }
        }
        Swal.fire('ØªÙ…Øª Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©', 'ØªÙ…Øª Ù…Ø²Ø§Ù…Ù†Ø© Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø¨Ù†Ø¬Ø§Ø­', 'success');
        loadContent();
    }
}

// --- Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ù„ÙØ§Øª JSON ---
function exportJSON() {
    db.ref('archive').once('value', snap => {
        let data = snap.val(); if(!data) return Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª', 'info');
        let filtered = {};
        for(let d in data) for(let s in data[d]) if(data[d][s][currentUser]) {
            if(!filtered[d]) filtered[d] = {};
            if(!filtered[d][s]) filtered[d][s] = {};
            filtered[d][s][currentUser] = data[d][s][currentUser];
        }
        const blob = new Blob([JSON.stringify(filtered, null, 2)], {type:'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `Backup_${currentUser}_${new Date().toISOString().slice(0,10)}.json`;
        a.click();
    });
}

function importJSON(input) {
    const file = input.files[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = async (e) => {
        try {
            const data = JSON.parse(e.target.result);
            const res = await Swal.fire({ title: 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯', text: "Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¯Ù…Ø¬ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù Ù…Ø¹ Ø§Ù„Ø£Ø±Ø´ÙŠÙØŸ", showCancelButton: true });
            if(res.isConfirmed) {
                for(let d in data) for(let s in data[d]) if(data[d][s][currentUser]) {
                    db.ref(`archive/${d}/${s}/${currentUser}`).set(data[d][s][currentUser]);
                }
                Swal.fire('Ù†Ø¬Ø§Ø­', 'ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…Ù„Ù', 'success'); loadContent();
            }
        } catch(err) { Swal.fire('Ø®Ø·Ø£', 'ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…Ù„Ù ØºÙŠØ± ØµØ­ÙŠØ­', 'error'); }
    };
    reader.readAsText(file);
}

// --- Ø§Ù„Ù…Ø­Ø±Ùƒ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ ---
function liveUpdate() {
    let tp = 0, ts = 0;
    document.querySelectorAll('#tbody tr').forEach(row => {
        let l = parseFloat(row.cells[1].querySelector('input').value) || 0;
        let s = parseFloat(row.cells[2].querySelector('input').value) || 0;
        let r = l * s; row.cells[3].innerText = r.toFixed(0);
        tp += r; ts += s;
    });
    document.getElementById('sumTotal').innerText = tp.toFixed(0);
    document.getElementById('sumSizes').innerText = ts.toFixed(1);
    clearTimeout(window.saveT); window.saveT = setTimeout(silentSave, 2000);
}

function silentSave() {
    if (!activeUser || (currentUser !== activeUser && users[currentUser].role !== 'super')) return;
    let data = [];
    document.querySelectorAll('#tbody tr').forEach(row => {
        let n = row.cells[0].querySelector('input').value;
        if(n.trim() !== "") data.push({ 
            name: n, 
            l: row.cells[1].querySelector('input').value, 
            s: row.cells[2].querySelector('input').value, 
            line: row.cells[4].querySelector('input').value, 
            note: row.cells[5].querySelector('input').value 
        });
    });
    db.ref(`archive/${activeDay}/${activeShift}/${activeUser}`).set(data);
}

function addRow(d = {name:'', l:0, s:0, line:1, note:''}) {
    const r = document.getElementById('tbody').insertRow();
    r.innerHTML = `
        <td><input type="text" value="${d.name}"></td>
        <td><input type="number" value="${d.l}"></td>
        <td><input type="number" value="${d.s}"></td>
        <td style="font-weight:bold;">0</td>
        <td><input type="text" value="${d.line}"></td>
        <td><input type="text" value="${d.note}"></td>
        <td class="noPrint"><button onclick="this.closest('tr').remove(); liveUpdate();" style="color:red; background:none; border:none;">âœ–</button></td>`;
    liveUpdate();
}

function loadContent() {
    document.getElementById('tbody').innerHTML = '';
    db.ref(`archive/${activeDay}/${activeShift}/${activeUser}`).once('value', snap => {
        (snap.val() || []).forEach(item => addRow(item));
        liveUpdate();
    });
}

// --- Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© ---
function listenForNotifications() {
    db.ref('chats').on('value', snap => {
        let unread = 0; const all = snap.val() || {};
        if (users[currentUser].role === 'super') {
            Object.keys(all).forEach(k => Object.keys(all[k]).forEach(mId => {
                if (all[k][mId].sender !== currentUser && !all[k][mId].isRead) unread++;
            }));
        } else {
            const my = all[currentUser] || {};
            Object.keys(my).forEach(mId => { if (my[mId].sender !== currentUser && !my[mId].isRead) unread++; });
        }
        const b = document.getElementById('unreadBadge');
        if (unread > 0) { b.innerText = unread; b.style.display = 'flex'; } else b.style.display = 'none';
    });
}

function toggleChat() {
    isChatOpen = !isChatOpen;
    document.getElementById('chatWindow').style.display = isChatOpen ? 'flex' : 'none';
    if(isChatOpen) loadChat();
}

function loadChat() {
    const path = users[currentUser].role === 'super' ? chatRecipient : currentUser;
    db.ref(`chats/${path}`).on('value', snap => {
        const msgs = snap.val() || {};
        document.getElementById('chatMessages').innerHTML = Object.keys(msgs).map(k => `
            <div class="msg ${msgs[k].sender===currentUser?'msg-me':'msg-them'}">${msgs[k].content}</div>
        `).join('');
        document.getElementById('chatMessages').scrollTop = 99999;
        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙƒÙ…Ù‚Ø±ÙˆØ¡Ø©
        Object.keys(msgs).forEach(k => {
            if(msgs[k].sender !== currentUser) db.ref(`chats/${path}/${k}/isRead`).set(true);
        });
    });
}

function sendMsg() {
    const i = document.getElementById('chatMsgInput');
    const path = users[currentUser].role==='super' ? chatRecipient : currentUser;
    if(!i.value.trim()) return;
    db.ref(`chats/${path}`).push({ sender: currentUser, content: i.value, time: Date.now(), isRead: false });
    i.value = '';
}

function setupChatUI() {
    const area = document.getElementById('chatRecipientArea');
    if (users[currentUser].role === 'super') {
        let s = `<select id="chatRecipientSelect" onchange="chatRecipient=this.value; loadChat();" style="width:100%;"><option value="">Ø§Ø®ØªØ± Ù…ÙˆØ¸Ù...</option>`;
        Object.keys(users).forEach(u => { if(u!==currentUser && users[u].role!=='super') s+=`<option value="${u}">${u}</option>`; });
        area.innerHTML = s + `</select>`;
    } else { area.innerHTML = `<span style="font-size:12px;">Ù…Ø±Ø§Ø³Ù„Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</span>`; chatRecipient = "admin"; }
}

function initApp() {
    db.ref('users').on('value', snap => { 
        users = snap.val() || users; 
        const uSelect = document.getElementById('userSelect');
        if (users[currentUser].role === 'super') {
            uSelect.innerHTML = Object.keys(users).filter(u => users[u].role !== 'super').map(u => `<option value="${u}" ${u===activeUser?'selected':''}>${u}</option>`).join('');
        } else { uSelect.innerHTML = `<option value="${currentUser}">${currentUser}</option>`; }
        renderAdmin(); 
    });
    db.ref('.info/connected').on('value', snap => {
        document.getElementById('connDot').style.background = snap.val() ? "#2ecc71" : "#e74c3c";
        document.getElementById('connText').innerText = snap.val() ? "Ù…ØªØµÙ„" : "Ø£ÙˆÙÙ„Ø§ÙŠÙ†";
    });
}

function switchContext() { 
    activeUser = document.getElementById('userSelect').value; 
    activeShift = document.getElementById('shiftSelect').value; 
    activeDay = document.getElementById('daySelect').value;
    loadContent(); 
}

function renderAdmin() {
    if(users[currentUser].role !== 'super') return;
    document.getElementById('adminPanel').style.display = 'block';
    document.getElementById('usersList').innerHTML = Object.keys(users).filter(u => users[u].role !== 'super').map(u => `
        <div style="display:flex; justify-content:space-between; padding:5px; border-bottom:1px solid #eee;">
            <span>ğŸ‘¤ ${u}</span><button onclick="if(confirm('Ø­Ø°ÙØŸ')) db.ref('users/'+'${u}').remove()" style="color:red; background:none; border:none;">Ø­Ø°Ù</button>
        </div>`).join('');
}

function addNewWorker() {
    let n = document.getElementById('newWorkerName').value.trim();
    let p = document.getElementById('newWorkerPass').value.trim();
    if(n && p) db.ref('users/' + n).set({ pass: btoa(p), role: "user" });
}
</script>
</body>
</html>
