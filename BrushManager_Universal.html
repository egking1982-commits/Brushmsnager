<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>BrushManager Pro - Ù…Ø­Ù…ÙˆØ¯ Ø¨Ø¯ÙŠØ±</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <style>
        :root { --primary: #4361ee; --success: #2ec4b6; --danger: #f72585; --bg: #f0f2f5; --whatsapp: #25D366; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); margin: 0; padding: 10px; color: #333; }
        .card { background: #fff; border-radius: 18px; padding: 20px; box-shadow: 0 8px 20px rgba(0,0,0,0.06); margin-bottom: 15px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; margin-bottom: 15px; }
        .stat-card { background: #ffffff; padding: 15px; border-radius: 15px; text-align: center; border-bottom: 4px solid var(--primary); box-shadow: 0 4px 10px rgba(0,0,0,0.03); }
        .stat-card h4 { margin: 0; font-size: 12px; color: #777; font-weight: 600; }
        .stat-card p { margin: 8px 0 0; font-size: 20px; font-weight: 800; color: var(--primary); }
        .whatsapp-float { position: fixed; width: 60px; height: 60px; bottom: 20px; left: 20px; background-color: var(--whatsapp); color: #FFF; border-radius: 50px; text-align: center; font-size: 30px; box-shadow: 2px 2px 10px rgba(0,0,0,0.2); z-index: 1000; display: flex; align-items: center; justify-content: center; text-decoration: none; transition: transform 0.3s; }
        .login-box { max-width: 400px; margin: 50px auto; text-align: center; }
        .status-dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; margin-left: 5px; }
        .online { background: #2ecc71; box-shadow: 0 0 8px #2ecc71; }
        .offline { background: #e74c3c; box-shadow: 0 0 8px #e74c3c; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th { background: #343a40; color: white; padding: 12px; font-size: 13px; border: 1px solid #444; }
        td { padding: 5px; border: 1px solid #eee; text-align: center; }
        input, select { width: 92%; padding: 10px; border: 1.5 solid #ddd; border-radius: 8px; outline: none; text-align: center; font-size: 16px; }
        .btn { padding: 12px 18px; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; color: white; margin: 5px; font-size: 14px; }
        .btn-primary { background: var(--primary); }
        .btn-success { background: var(--success); }
        .btn-danger { background: var(--danger); }
        .btn-excel { background: #1d6f42; }
        .footer { text-align: center; padding: 20px; font-weight: bold; color: var(--primary); font-size: 14px; }
        @media print { .noPrint { display: none; } .whatsapp-float { display: none; } }
    </style>
</head>
<body>

<a href="https://wa.me/201288761131" class="whatsapp-float noPrint" target="_blank"><i>ğŸ’¬</i></a>

<div id="loginBox" class="card login-box">
    <h2 style="color:var(--primary);">ğŸ” BrushManager Pro</h2>
    <p style="color:#777; font-size:13px;">Ø¨Ø±Ù…Ø¬Ø© Ø£. Ù…Ø­Ù…ÙˆØ¯ Ø¨Ø¯ÙŠØ±</p>
    <div id="userLoginForm">
        <input id="username" type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" style="margin-bottom:10px;"><br>
        <input id="pass" type="password" placeholder="Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ" style="margin-bottom:15px;"><br>
        <button id="loginBtn" onclick="login('user')" class="btn btn-primary" style="width:100%">Ø¯Ø®ÙˆÙ„ / ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</button>
    </div>
    <div style="margin-top:20px; border-top:1px dashed #ccc; padding-top:15px;">
        <button onclick="document.getElementById('adminForm').style.display='block'" style="background:none; border:none; color:var(--primary); cursor:pointer; font-size: 12px;">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø³ÙˆØ¨Ø± Ø£Ø¯Ù…Ù† ğŸ› </button>
        <div id="adminForm" style="display:none; margin-top:10px;">
            <input id="adminUser" type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„" style="margin-bottom:10px;"><br>
            <input id="adminPass" type="password" placeholder="Ø§Ù„ÙƒÙˆØ¯" style="margin-bottom:10px;"><br>
            <button onclick="login('admin')" class="btn btn-danger" style="width:100%">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</button>
        </div>
    </div>
</div>

<div id="app" style="display:none;">
    <div class="card" style="display:flex; justify-content:space-between; align-items:center;">
        <div><span id="connDot" class="status-dot offline"></span> <span id="connText" style="font-size:11px;">Ù…Ø²Ø§Ù…Ù†Ø©...</span></div>
        <div style="font-weight:bold;">ğŸ‘¤ <span id="welcomeUser"></span></div>
        <button onclick="location.reload()" class="btn btn-danger" style="padding:5px 12px; font-size:11px;">Ø®Ø±ÙˆØ¬</button>
    </div>

    <div id="adminPanel" class="card noPrint" style="display:none; border:2px solid var(--danger);">
        <h4 style="color:var(--danger); margin-top:0;">ğŸ›  Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h4>
        <div id="usersList"></div>
    </div>

    <div class="card noPrint" style="display:flex; gap:10px; flex-wrap:wrap;">
        <div style="flex:1;"><select id="userSelect" onchange="switchUser()"></select></div>
        <div style="flex:1;"><select id="daySelect" onchange="loadDay()"></select></div>
    </div>

    <div id="printArea">
        <div class="stats-grid">
            <div class="stat-card"><h4>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚Ø·Ø¹</h4><p id="sumTotal">0</p></div>
            <div class="stat-card"><h4>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù‚Ø§Ø³Ø§Øª</h4><p id="sumSizes">0</p></div>
            <div class="stat-card"><h4>Ø§Ù„Ù…ØªÙˆØ³Ø·</h4><p id="avgTotal">0</p></div>
        </div>
        <div class="card" style="overflow-x:auto;">
            <table id="mainTable">
                <thead>
                    <tr><th>Ø§Ù„ÙØ±Ø´Ø©</th><th>Ø§Ù„Ø·Ø¨Ù‚Ø§Øª</th><th>Ø§Ù„Ù…Ù‚Ø§Ø³</th><th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th><th>Ø§Ù„Ø®Ø·</th><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th><th class="noPrint">âœ–</th></tr>
                </thead>
                <tbody id="tbody" oninput="liveUpdate()"></tbody>
            </table>
        </div>
        <div class="card noPrint"><canvas id="myChart" style="width:100%; max-height:240px;"></canvas></div>
    </div>

    <div class="card noPrint" style="text-align:center;">
        <button onclick="addRow()" class="btn btn-success">â• Ø¥Ø¶Ø§ÙØ© Ø³Ø·Ø±</button>
        <button onclick="exportExcel()" class="btn btn-excel">ğŸ“Š Excel</button>
        <button onclick="savePDF()" class="btn btn-danger">ğŸ“„ PDF</button>
        <div style="margin-top:10px;">
            <button onclick="exportJSON()" class="btn" style="background:#6c757d; font-size: 11px;">ğŸ“¤ ØªØµØ¯ÙŠØ± JSON</button>
            <button onclick="importJSON()" class="btn" style="background:#6f42c1; font-size: 11px;">ğŸ“¥ Ø¯Ù…Ø¬ JSON</button>
        </div>
    </div>
    <div class="footer">Ø¨Ø±Ù…Ø¬Ø© Ø£. Ù…Ø­Ù…ÙˆØ¯ Ø¨Ø¯ÙŠØ±</div>
</div>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyDDhfiJkDvafZQB57DA9jsF7R3iF8jokQI",
    authDomain: "brushmanager-98d94.firebaseapp.com",
    databaseURL: "https://brushmanager-98d94-default-rtdb.firebaseio.com",
    projectId: "brushmanager-98d94",
    appId: "1:319953455236:web:e7e93bf6073da63f1b1ad1"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let users = JSON.parse(localStorage.getItem('users') || '{"admin":{"pass":"MTIz","role":"super"}}');
let archive = JSON.parse(localStorage.getItem('archive') || '{}');
let currentUser, activeUser, activeDay, chartInstance, autoSaveTimer;

function login(type) {
    let u = (type === 'admin' ? document.getElementById('adminUser') : document.getElementById('username')).value.trim();
    let p = (type === 'admin' ? document.getElementById('adminPass') : document.getElementById('pass')).value;
    if(!u || !p) return alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");

    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
    if (users[u]) {
        if (users[u].pass === btoa(p)) {
            startSession(u);
        } else {
            alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ");
        }
    } 
    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø³ØªØ®Ø¯Ù…Ø§Ù‹ Ø¬Ø¯ÙŠØ¯Ø§Ù‹ (ÙÙ‚Ø· Ù„Ù†ÙˆØ¹ user ÙˆÙ„ÙŠØ³ Ù„Ù„Ø£Ø¯Ù…Ù†)
    else if (type === 'user') {
        if(confirm(`Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… "${u}" ØºÙŠØ± Ù…Ø³Ø¬Ù„ØŒ Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯ØŸ`)) {
            users[u] = { pass: btoa(p), role: "user" };
            saveUsers();
            startSession(u);
        }
    } else {
        alert("Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©");
    }
}

function startSession(u) {
    currentUser = activeUser = u;
    activeDay = new Date().toISOString().split('T')[0];
    document.getElementById('loginBox').style.display = 'none';
    document.getElementById('app').style.display = 'block';
    document.getElementById('welcomeUser').innerText = u;
    if(users[u].role === 'super') document.getElementById('adminPanel').style.display = 'block';
    updateStatus(navigator.onLine);
    initApp();
    loadContent(); // ØªØ­Ù…ÙŠÙ„ ÙÙˆØ±ÙŠ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø­Ø§Ù„ÙŠ
}

function initApp() {
    archive = JSON.parse(localStorage.getItem('archive') || '{}');
    updateSelectors();
    
    // Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ù† ÙÙŠØ±Ø¨ÙŠØ²
    db.ref('users').on('value', snap => { 
        if(snap.exists()){ 
            users = snap.val(); 
            localStorage.setItem('users', JSON.stringify(users)); 
            updateSelectors(); 
            renderAdmin(); 
        } 
    });

    // Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø£Ø±Ø´ÙŠÙ Ù…Ù† ÙÙŠØ±Ø¨ÙŠØ²
    db.ref('archive').on('value', snap => { 
        if(snap.exists()){ 
            archive = snap.val(); 
            localStorage.setItem('archive', JSON.stringify(archive)); 
            loadContent(); 
        } 
    });
}

function liveUpdate() {
    let totalPieces = 0, totalSizes = 0, count = 0;
    const rows = document.getElementById('tbody').rows;
    for (let row of rows) {
        let layers = parseFloat(row.cells[1].querySelector('input').value) || 0;
        let size = parseFloat(row.cells[2].querySelector('input').value) || 0;
        let result = layers * size;
        row.cells[3].innerText = result.toFixed(0);
        totalPieces += result; totalSizes += size;
        if(layers > 0 || size > 0) count++;
    }
    document.getElementById('sumTotal').innerText = totalPieces.toFixed(0);
    document.getElementById('sumSizes').innerText = totalSizes.toFixed(1);
    document.getElementById('avgTotal').innerText = count > 0 ? (totalPieces/count).toFixed(1) : 0;

    clearTimeout(autoSaveTimer);
    autoSaveTimer = setTimeout(silentSave, 1500);
}

function silentSave() {
    if (currentUser !== activeUser && users[currentUser].role !== 'super') return;
    let data = [];
    document.querySelectorAll('#tbody tr').forEach(row => {
        data.push({
            name: row.cells[0].querySelector('input').value,
            l: row.cells[1].querySelector('input').value,
            s: row.cells[2].querySelector('input').value,
            line: row.cells[4].querySelector('input').value,
            note: row.cells[5].querySelector('input').value
        });
    });
    
    if (!archive[activeDay]) archive[activeDay] = {};
    archive[activeDay][activeUser] = data;
    
    // Ø­ÙØ¸ Ù…Ø­Ù„ÙŠ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø¹Ù…Ù„ Ø£ÙˆÙÙ„Ø§ÙŠÙ†
    localStorage.setItem('archive', JSON.stringify(archive));
    
    // Ø±ÙØ¹ Ù„Ù„Ø³ÙŠØ±ÙØ± ÙÙŠ Ø­Ø§Ù„Ø© ÙˆØ¬ÙˆØ¯ Ø¥Ù†ØªØ±Ù†Øª
    if(navigator.onLine) {
        db.ref(`archive/${activeDay}/${activeUser}`).set(data);
    }
    updateChart();
}

function updateChart() {
    let labels = [], values = [];
    document.querySelectorAll('#tbody tr').forEach(row => {
        labels.push(row.cells[0].querySelector('input').value || '-');
        values.push(parseFloat(row.cells[3].innerText) || 0);
    });
    const ctx = document.getElementById('myChart').getContext('2d');
    if (chartInstance) chartInstance.destroy();
    chartInstance = new Chart(ctx, {
        type: 'bar',
        data: { labels, datasets: [{ label: 'Ø§Ù„Ø¥Ù†ØªØ§Ø¬', data: values, backgroundColor: '#4361ee' }] },
        options: { responsive: true, animation: { duration: 0 } }
    });
}

function addRow(data = {name:'', l:0, s:0, line:1, note:''}) {
    const row = document.getElementById('tbody').insertRow();
    row.innerHTML = `
        <td><input type="text" value="${data.name}"></td>
        <td><input type="number" value="${data.l}" inputmode="decimal"></td>
        <td><input type="number" value="${data.s}" inputmode="decimal"></td>
        <td style="font-weight:bold;">0</td>
        <td><input type="text" value="${data.line}"></td>
        <td><input type="text" value="${data.note}"></td>
        <td class="noPrint"><button onclick="this.closest('tr').remove(); liveUpdate();" style="color:red; background:none; border:none; cursor:pointer;">âœ–</button></td>
    `;
    liveUpdate();
}

function loadContent() {
    if(document.activeElement && document.activeElement.tagName === 'INPUT') return;
    document.getElementById('tbody').innerHTML = '';
    let d = (archive[activeDay] || {})[activeUser] || [];
    if(d.length === 0) addRow(); else d.forEach(item => addRow(item));
}

function exportExcel() {
    const ws = XLSX.utils.table_to_sheet(document.getElementById("mainTable"));
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Data");
    XLSX.writeFile(wb, `Export_${activeUser}.xlsx`);
}

function savePDF() {
    const { jsPDF } = window.jspdf;
    html2canvas(document.getElementById('printArea')).then(canvas => {
        const pdf = new jsPDF('p', 'mm', 'a4');
        pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 10, 210, 0);
        pdf.save(`Report_${activeDay}.pdf`);
    });
}

function exportJSON() {
    const b = new Blob([JSON.stringify(archive)], {type: "application/json"});
    const a = document.createElement("a"); a.href = URL.createObjectURL(b); a.download = `Backup.json`; a.click();
}

function importJSON() {
    const inp = document.createElement('input'); inp.type = 'file';
    inp.onchange = e => {
        const r = new FileReader();
        r.onload = ev => {
            const imp = JSON.parse(ev.target.result);
            for(let d in imp) { if(!archive[d]) archive[d]={}; for(let u in imp[d]) archive[d][u]=imp[d][u]; }
            db.ref('archive').set(archive).then(() => location.reload());
        };
        r.readAsText(e.target.files[0]);
    }; inp.click();
}

function updateStatus(on) {
    const d = document.getElementById('connDot');
    const t = document.getElementById('connText');
    d.className = "status-dot " + (on ? "online" : "offline");
    t.innerText = on ? "Ù…ØªØµÙ„" : "Ø£ÙˆÙÙ„Ø§ÙŠÙ†";
}
window.addEventListener('online', () => updateStatus(true));
window.addEventListener('offline', () => updateStatus(false));

function renderAdmin() {
    document.getElementById('usersList').innerHTML = Object.keys(users).map(u => `
        <div style="display:flex; justify-content:space-between; padding:5px; border-bottom:1px solid #eee;">
            <span>${u}</span>
            ${u!=='admin' ? `<button onclick="deleteU('${u}')" style="color:red; border:none; background:none;">Ø­Ø°Ù</button>` : ''}
        </div>`).join('');
}
function deleteU(u) { if(confirm(`Ø­Ø°Ù ${u}ØŸ`)) { delete users[u]; db.ref('users').set(users); } }

function updateSelectors() {
    document.getElementById('userSelect').innerHTML = Object.keys(users).map(u => `<option value="${u}" ${u===activeUser?'selected':''}>${u}</option>`).join('');
    let days = Object.keys(archive).sort().reverse();
    let t = new Date().toISOString().split('T')[0];
    if(!days.includes(t)) days.unshift(t);
    document.getElementById('daySelect').innerHTML = [...new Set(days)].map(d => `<option value="${d}" ${d===activeDay?'selected':''}>${d}</option>`).join('');
}
function switchUser() { activeUser = document.getElementById('userSelect').value; loadContent(); }
function loadDay() { activeDay = document.getElementById('daySelect').value; loadContent(); }
function saveUsers() { localStorage.setItem('users', JSON.stringify(users)); db.ref('users').set(users); }
</script>
</body>
</html>

