<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>BrushManager Pro - V3.0.0 Ultimate</title>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4361ee">
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root { --primary: #4361ee; --success: #2ec4b6; --danger: #f72585; --bg: #f0f2f5; --dark: #2d3436; --warning: #ff9f43; --supervisor: #6c5ce7; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); margin: 0; padding: 10px; padding-bottom: 60px; }
        .card { background: #fff; border-radius: 18px; padding: 20px; box-shadow: 0 8px 20px rgba(0,0,0,0.06); margin-bottom: 15px; }
        
        .log-container { max-height: 200px; overflow-y: auto; background: #1e272e; color: #0be881; border-radius: 10px; padding: 10px; font-family: monospace; font-size: 11px; }
        .log-row { border-bottom: 1px solid #3d3d3d; padding: 4px 0; display: flex; justify-content: space-between; }

        table { width: 100%; border-collapse: collapse; background: white; min-width: 600px; }
        th { background: var(--dark); color: white; padding: 12px; font-size: 13px; }
        td { padding: 5px; border: 1px solid #ddd; text-align: center; }
        input, select { width: 92%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; text-align: center; font-size: 14px; }
        .btn { padding: 10px 15px; border: none; border-radius: 12px; cursor: pointer; font-weight: bold; color: white; transition: 0.3s; margin: 5px; }
        
        #chatBox { position: fixed; bottom: 80px; left: 20px; width: 340px; height: 500px; background: white; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); display: none; flex-direction: column; z-index: 1000; overflow: hidden; border: 1px solid #ddd; }
        #chatMessages { flex: 1; padding: 10px; overflow-y: auto; background: #f0f2f5; display: flex; flex-direction: column; gap: 10px; }
        .msg { max-width: 85%; padding: 10px; border-radius: 15px; font-size: 13px; position: relative; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .msg.sent { align-self: flex-end; background: var(--primary); color: white; border-bottom-right-radius: 2px; }
        .msg.received { align-self: flex-start; background: white; color: #000; border-bottom-left-radius: 2px; }
        
        .msg-actions { display: none; position: absolute; top: -15px; left: 5px; background: white; border: 1px solid #ddd; border-radius: 8px; padding: 2px 5px; gap: 8px; z-index: 10; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .msg:hover .msg-actions { display: flex; }
        .msg-actions span { cursor: pointer; font-size: 12px; }

        .attachment-preview { max-width: 100%; border-radius: 8px; margin-top: 5px; cursor: pointer; border: 1px solid #eee; }
        #fileInput { display: none; }

        #chatToggle { position: fixed; bottom: 80px; left: 20px; width: 60px; height: 60px; background: var(--primary); border-radius: 50%; display: none; justify-content: center; align-items: center; color: white; font-size: 24px; cursor: pointer; z-index: 999; }

        .footer-rights { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--dark); color: white; text-align: center; padding: 10px 0; font-size: 12px; z-index: 998; }
        .passkey-btn { background: #636e72; font-size: 11px; margin-top: 10px; opacity: 0.8; }

        @media print { 
            .noPrint, .footer-rights, #chatToggle, #chatBox { display: none !important; } 
            #printableArea, #adminArea { display: block !important; }
            .card { box-shadow: none; border: 1px solid #000; margin: 0; padding: 10px; }
            body { background: white; padding: 0; }
            .log-container { max-height: none; background: white; color: black; border: 1px solid #ccc; }
            .log-row { border-bottom: 1px solid #eee; color: black; }
        }
    </style>
</head>
<body>

<div id="loginBox" class="card" style="max-width:400px; margin:50px auto; text-align:center;">
    <h2 style="color:var(--primary);">ğŸ›¡ï¸ BrushManager Ultimate</h2>
    <p style="font-size: 12px; color: #666;">Ø¥Ø¯Ø§Ø±Ø© Ù…ØµÙ†Ø¹ Ø§Ù„ÙØ±Ø´ Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„Ø©</p>
    <div id="standardLogin">
        <input id="username" type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…"><br><br>
        <input id="pass" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"><br><br>
        <button onclick="login()" class="btn" style="background:var(--primary); width:100%">Ø¯Ø®ÙˆÙ„ Ø¢Ù…Ù†</button>
        <button onclick="loginWithPasskey()" class="btn passkey-btn">ğŸ”‘ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹ (Passkey)</button>
    </div>
</div>

<div id="app" style="display:none;">
    <div class="card noPrint" style="display:flex; justify-content:space-between; align-items:center;">
        <div>ğŸŸ¢ <span id="connText">Ù…ØªØµÙ„</span> | Ù…Ø±Ø­Ø¨Ø§Ù‹: <b id="welcomeUser"></b> <span id="roleBadge"></span></div>
        <div>
            <button onclick="printReport()" class="btn" style="background:var(--dark)">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
            <button onclick="location.reload()" class="btn" style="background:var(--danger)">Ø®Ø±ÙˆØ¬</button>
        </div>
    </div>

    <div id="adminArea" class="card noPrint" style="display:none; border: 2px solid var(--warning);">
        <h4 style="margin:0 0 10px 0; color:var(--dark);">ğŸ“œ Ø³Ø¬Ù„ Ù†Ø´Ø§Ø· Ø§Ù„Ù†Ø¸Ø§Ù… (Audit Log)</h4>
        <div id="auditLogs" class="log-container"></div>
        <div style="margin-top:10px;">
            <button onclick="clearSystemLogs()" class="btn" style="background:var(--danger); font-size:11px;">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹</button>
            <button onclick="window.print()" class="btn" style="background:var(--primary); font-size:11px;">ğŸ“‹ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø³Ø¬Ù„</button>
        </div>
        
        <hr style="margin:20px 0; opacity:0.2;">
        
        <h4 style="color:var(--danger); margin:0 0 10px 0;">ğŸ› ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</h4>
        <div style="display:flex; gap:5px; margin-bottom:15px;">
            <input id="newWorkerName" type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù">
            <input id="newWorkerPass" type="text" placeholder="Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯">
            <button onclick="addNewWorker()" class="btn" style="background:var(--success)">Ø¥Ø¶Ø§ÙØ©</button>
        </div>
        <div id="usersList"></div>
    </div>

    <div class="card noPrint" style="display:flex; gap:10px; flex-wrap:wrap;">
        <div style="flex:1;"><label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input type="date" id="daySelect" onchange="switchContext()"></div>
        <div style="flex:1;"><label>Ø§Ù„ÙˆØ±Ø¯ÙŠØ©</label>
            <select id="shiftSelect" onchange="switchContext()">
                <option value="ÙˆØ±Ø¯ÙŠØ©_1">Ø§Ù„Ø£ÙˆÙ„Ù‰</option>
                <option value="ÙˆØ±Ø¯ÙŠØ©_2">Ø§Ù„Ø«Ø§Ù†ÙŠØ©</option>
                <option value="ÙˆØ±Ø¯ÙŠØ©_3">Ø§Ù„Ø«Ø§Ù„Ø«Ø©</option>
            </select>
        </div>
        <div style="flex:1;"><label>Ø§Ù„Ù…ÙˆØ¸Ù</label><select id="userSelect" onchange="switchContext()"></select></div>
    </div>

    <div id="printableArea" class="card">
        <div style="display:flex; justify-content:space-around; margin-bottom:15px; background:var(--bg); padding:10px; border-radius:10px;">
            <div>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚Ø·Ø¹: <b id="sumTotal" style="color:var(--primary); font-size:18px;">0</b></div>
            <div>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù‚Ø§Ø³Ø§Øª: <b id="sumSizes" style="color:var(--success); font-size:18px;">0</b></div>
        </div>
        <div style="overflow-x:auto;">
            <table id="mainTable">
                <thead><tr><th>Ø§Ù„ÙØ±Ø´Ø©</th><th>Ø§Ù„Ø·Ø¨Ù‚Ø§Øª</th><th>Ø§Ù„Ù…Ù‚Ø§Ø³</th><th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th><th>Ø§Ù„Ø®Ø·</th><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th><th class="noPrint">âœ–</th></tr></thead>
                <tbody id="tbody" oninput="liveUpdate()"></tbody>
            </table>
        </div>
        <br>
        <button onclick="addRow()" class="btn noPrint" style="background:var(--success); width:100%">â• Ø¥Ø¶Ø§ÙØ© Ø³Ø·Ø± Ø¬Ø¯ÙŠØ¯</button>
    </div>

    <div class="card noPrint" style="text-align:center;">
        <button onclick="cloudBackup()" class="btn" style="background:#0984e3;">ğŸ“¤ Ø±ÙØ¹ Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ù…ØµÙ†Ø¹</button>
        <button onclick="cloudRestore()" id="restoreBtn" class="btn" style="background:#6c5ce7;">ğŸ“¥ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø£Ø±Ø´ÙŠÙ</button>
    </div>
</div>

<div id="chatToggle" onclick="toggleChat()">ğŸ’¬</div>

<div id="chatBox">
    <div style="background:var(--primary); color:white; padding:12px; font-weight:bold; display:flex; justify-content:space-between; align-items:center;">
        <span>ğŸ’¬ Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø©</span>
        <button onclick="askNotificationPermission()" style="background:rgba(255,255,255,0.2); border:none; border-radius:5px; color:white; font-size:10px; cursor:pointer; padding:2px 5px;">ğŸ”” ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</button>
    </div>
    <div style="padding:5px; background:#f8f9fa; border-bottom:1px solid #eee;">
        <select id="chatRecipient" style="width:100%; height:30px; font-size:11px;"></select>
    </div>
    <div id="chatMessages"></div>
    <div style="padding:10px; border-top:1px solid #eee; display:flex; align-items:center; gap:5px;">
        <button onclick="document.getElementById('fileInput').click()" style="background:none; border:none; font-size:18px; cursor:pointer;">ğŸ“</button>
        <input type="file" id="fileInput" onchange="handleFileUpload(this)" style="display:none;">
        <input type="text" id="chatMsgInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ..." onkeypress="if(event.key==='Enter') sendChatMessage()" style="flex:1;">
        <button onclick="sendChatMessage()" style="background:var(--primary); color:white; border:none; border-radius:50%; width:35px; height:35px;">âœˆ</button>
    </div>
</div>

<div class="footer-rights">
    Ø¬Ù…ÙŠØ¹ Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ù…Ø§Ù„ÙƒÙŠØ© Ù…Ø­ÙÙˆØ¸Ø© (Ù…Ø­Ù…ÙˆØ¯ Ø¨Ø¯ÙŠØ±) Â© 2026 - BrushManager Pro V3.0.0
</div>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyDDhfiJkDvafZQB57DA9jsF7R3iF8jokQI",
    authDomain: "brushmanager-98d94.firebaseapp.com",
    databaseURL: "https://brushmanager-98d94-default-rtdb.firebaseio.com",
    projectId: "brushmanager-98d94",
    appId: "1:319953455236:web:e7e93bf6073da63f1b1ad1"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let currentUser, activeUser, activeDay, activeShift;
let users = {};
let lastMessageCount = 0;
const notifSound = new Audio('https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3');

const THE_PASSKEY = "2026"; 

// --- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¯Ø®ÙˆÙ„ ---
function login() {
    let u = document.getElementById('username').value.trim();
    let p = document.getElementById('pass').value;
    db.ref('users').once('value', snap => {
        users = snap.val() || {"admin":{"pass":"MTIz","role":"super"}};
        if (users[u] && users[u].pass === btoa(p)) {
            currentUser = activeUser = u;
            startApp();
            logSystem("Ø¯Ø®ÙˆÙ„", "ØªÙ‚Ù„ÙŠØ¯ÙŠ");
        } else Swal.fire('Ø®Ø·Ø£', 'Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø©', 'error');
    });
}

async function loginWithPasskey() {
    const { value: key } = await Swal.fire({
        title: 'Ø£Ø¯Ø®Ù„ Passkey Ù„Ù„Ù…Ø´Ø±Ù',
        input: 'password',
        inputPlaceholder: 'Ø±Ù…Ø² Ø§Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹',
        showCancelButton: true
    });
    if (key === THE_PASSKEY) {
        currentUser = activeUser = "mahmoudbidear";
        db.ref('users/mahmoudbidear').once('value', snap => {
            if(!snap.val()) db.ref('users/mahmoudbidear').set({ pass: btoa("1"), role: "supervisor" });
            users["mahmoudbidear"] = { role: "supervisor" };
            startApp();
            logSystem("Ø¯Ø®ÙˆÙ„ Ø³Ø±ÙŠØ¹", "Passkey");
        });
    } else if (key) Swal.fire('Ø®Ø·Ø£', 'Ø±Ù…Ø² ØºÙŠØ± ØµØ­ÙŠØ­', 'error');
}

function startApp() {
    document.getElementById('loginBox').style.display = 'none';
    document.getElementById('app').style.display = 'block';
    document.getElementById('chatToggle').style.display = 'flex';
    document.getElementById('welcomeUser').innerText = currentUser;
    
    const role = users[currentUser]?.role || 'user';
    if(role === 'super' || role === 'supervisor') {
        document.getElementById('adminArea').style.display = 'block';
        document.getElementById('roleBadge').innerHTML = `<small style="background:var(--supervisor); color:white; padding:2px 8px; border-radius:10px;">${role==='super'?'Ù…Ø¯ÙŠØ±':'Ù…Ø´Ø±Ù'}</small>`;
        listenToAudit();
        renderAdminUsers();
    }
    
    activeDay = new Date().toISOString().split('T')[0];
    document.getElementById('daySelect').value = activeDay;
    activeShift = "ÙˆØ±Ø¯ÙŠØ©_1";
    updateUserSelector();
    loadContent();
    initChat();
    updateRecipientList();
}

// --- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ø¬Ø¯ÙˆÙ„ ---
function logSystem(action, details) {
    db.ref('system_audit').push({ user: currentUser, action: action, details: details, time: new Date().toLocaleString('ar-EG') });
}

function listenToAudit() {
    db.ref('system_audit').limitToLast(50).on('value', snap => {
        const logs = snap.val() || {};
        document.getElementById('auditLogs').innerHTML = Object.values(logs).reverse().map(l => `<div class="log-row"><span>[${l.time}] <b>${l.user}</b></span><span>${l.action}: ${l.details}</span></div>`).join('');
    });
}

// Ù…ÙŠØ²Ø© Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
function clearSystemLogs() {
    Swal.fire({
        title: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ',
        text: "Ø³ÙŠØªÙ… Ù…Ø³Ø­ Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø· Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹!",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#f72585',
        confirmButtonText: 'Ù†Ø¹Ù…ØŒ Ø§Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„'
    }).then((result) => {
        if (result.isConfirmed) {
            db.ref('system_audit').remove();
            logSystem("Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„", "Ù‚Ø§Ù… Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø¨Ù…Ø³Ø­ Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…");
            Swal.fire('ØªÙ… Ø§Ù„Ù…Ø³Ø­', 'ØªÙ… ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø³Ø¬Ù„ Ø¨Ù†Ø¬Ø§Ø­', 'success');
        }
    });
}

function liveUpdate() {
    let tp = 0, ts = 0;
    document.querySelectorAll('#tbody tr').forEach(row => {
        let l = parseFloat(row.cells[1].querySelector('input').value) || 0;
        let s = parseFloat(row.cells[2].querySelector('input').value) || 0;
        let r = l * s;
        row.cells[3].innerText = r.toFixed(0);
        tp += r; ts += s;
    });
    document.getElementById('sumTotal').innerText = tp.toFixed(0);
    document.getElementById('sumSizes').innerText = ts.toFixed(1);
    clearTimeout(window.saveT);
    window.saveT = setTimeout(saveData, 1500);
}

function addRow(d = {name:'', l:0, s:0, line:1, note:''}) {
    const r = document.getElementById('tbody').insertRow();
    r.innerHTML = `<td><input type="text" value="${d.name}"></td><td><input type="number" value="${d.l}"></td><td><input type="number" value="${d.s}"></td><td style="font-weight:bold;">0</td><td><input type="text" value="${d.line}"></td><td><input type="text" value="${d.note}"></td><td class="noPrint"><button onclick="this.closest('tr').remove(); liveUpdate();" style="color:red; background:none; border:none;">âœ–</button></td>`;
    liveUpdate();
}

function saveData() {
    let data = [];
    document.querySelectorAll('#tbody tr').forEach(row => {
        const name = row.cells[0].querySelector('input').value;
        if(name.trim() !== "") data.push({ name, l: row.cells[1].querySelector('input').value, s: row.cells[2].querySelector('input').value, line: row.cells[4].querySelector('input').value, note: row.cells[5].querySelector('input').value });
    });
    db.ref(`archive/${activeDay}/${activeShift}/${activeUser}`).set(data);
}

function loadContent() {
    document.getElementById('tbody').innerHTML = '';
    db.ref(`archive/${activeDay}/${activeShift}/${activeUser}`).once('value', snap => {
        let data = snap.val() || [];
        if(data.length > 0) data.forEach(item => addRow(item)); else addRow();
    });
}

function switchContext() {
    activeUser = document.getElementById('userSelect').value;
    activeDay = document.getElementById('daySelect').value;
    activeShift = document.getElementById('shiftSelect').value;
    loadContent();
}

// --- Ù†Ø¸Ø§Ù… Ø§Ù„Ø´Ø§Øª ---
function askNotificationPermission() { Notification.requestPermission(); }

function initChat() {
    db.ref('chats/global').limitToLast(30).on('value', snap => {
        const msgDiv = document.getElementById('chatMessages');
        const data = snap.val() || {};
        const msgIds = Object.keys(data);
        if(msgIds.length > lastMessageCount && lastMessageCount !== 0) {
            const lastMsg = data[msgIds[msgIds.length-1]];
            if(lastMsg.sender !== currentUser && (lastMsg.to === 'all' || lastMsg.to === currentUser)) {
                notifSound.play().catch(e => {});
                if(Notification.permission === "granted") new Notification(`Ø±Ø³Ø§Ù„Ø© Ù…Ù† ${lastMsg.sender}`, { body: lastMsg.text || "Ø£Ø±Ø³Ù„ Ù…Ù„ÙØ§Ù‹" });
            }
        }
        lastMessageCount = msgIds.length;
        msgDiv.innerHTML = '';
        msgIds.forEach(id => {
            const m = data[id];
            if(m.to === 'all' || m.sender === currentUser || m.to === currentUser) {
                const isMine = m.sender === currentUser;
                const div = document.createElement('div');
                div.className = `msg ${isMine ? 'sent' : 'received'}`;
                let fileHTML = '';
                if(m.file) {
                    if(m.fileType?.includes('image')) fileHTML = `<img src="${m.file}" class="attachment-preview" onclick="window.open(this.src)">`;
                    else fileHTML = `<br><a href="${m.file}" download="file" style="color:inherit; font-size:11px;">ğŸ“‚ Ù…Ù„Ù Ù…Ø±ÙÙ‚</a>`;
                }
                const actions = isMine ? `<div class="msg-actions"><span onclick="editMsg('${id}', '${m.text}')">âœï¸</span><span onclick="deleteMsg('${id}')">ğŸ—‘ï¸</span></div>` : '';
                div.innerHTML = `${actions}<b>${m.sender}:</b><br>${m.text || ''}${fileHTML}`;
                msgDiv.appendChild(div);
            }
        });
        msgDiv.scrollTop = msgDiv.scrollHeight;
    });
}

async function sendChatMessage(fileData = null, fileType = null) {
    const i = document.getElementById('chatMsgInput');
    const msgText = i.value.trim();
    const recipient = document.getElementById('chatRecipient').value;
    if(!msgText && !fileData) return;
    const payload = { sender: currentUser, to: recipient, text: msgText, time: firebase.database.ServerValue.TIMESTAMP };
    if(fileData) { payload.file = fileData; payload.fileType = fileType; }
    await db.ref('chats/global').push(payload);
    i.value = ''; document.getElementById('fileInput').value = '';
}

function handleFileUpload(input) {
    const file = input.files[0];
    if (file) {
        if (file.size > 800000) { Swal.fire('Ø®Ø·Ø£', 'Ø§Ù„Ù…Ù„Ù ÙƒØ¨ÙŠØ± (Ø§Ù„Ø£Ù‚ØµÙ‰ 800KB)', 'error'); return; }
        const reader = new FileReader();
        reader.onload = (e) => sendChatMessage(e.target.result, file.type);
        reader.readAsDataURL(file);
    }
}

async function editMsg(id, old) {
    const { value: text } = await Swal.fire({ title: 'ØªØ¹Ø¯ÙŠÙ„', input: 'text', inputValue: old, showCancelButton: true });
    if (text) db.ref(`chats/global/${id}`).update({ text: text + " (Ù…Ø¹Ø¯Ù„Ø©)" });
}

function deleteMsg(id) { if(confirm("Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø©ØŸ")) db.ref(`chats/global/${id}`).remove(); }

function toggleChat() { 
    const b = document.getElementById('chatBox'); 
    b.style.display = b.style.display==='flex'?'none':'flex'; 
}

// --- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ---
function renderAdminUsers() {
    db.ref('users').on('value', snap => {
        const all = snap.val() || {};
        document.getElementById('usersList').innerHTML = Object.keys(all).filter(u => all[u].role === 'user').map(u => `<div style="display:flex; justify-content:space-between; padding:8px; border-bottom:1px solid #eee;"><span>ğŸ‘¤ <b>${u}</b></span><button onclick="deleteWorker('${u}')" style="color:red; border:none; background:none; cursor:pointer;">âœ– Ø­Ø°Ù</button></div>`).join('');
    });
}

function addNewWorker() {
    const n = document.getElementById('newWorkerName').value.trim();
    const p = document.getElementById('newWorkerPass').value.trim();
    if(n && p) {
        db.ref(`users/${n}`).set({ pass: btoa(p), role: 'user' });
        logSystem("Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù", `ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ¸Ù ${n}`);
    }
}

function deleteWorker(n) { 
    if(confirm(`Ø­Ø°Ù ${n}ØŸ`)) {
        db.ref(`users/${n}`).remove();
        logSystem("Ø­Ø°Ù Ù…ÙˆØ¸Ù", `ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ¸Ù ${n}`);
    }
}

function updateUserSelector() {
    const sel = document.getElementById('userSelect');
    db.ref('users').once('value', snap => {
        const u = snap.val() || {};
        if(users[currentUser].role === 'super' || users[currentUser].role === 'supervisor') {
            sel.innerHTML = Object.keys(u).map(x => `<option value="${x}" ${x===currentUser?'selected':''}>${x}</option>`).join('');
        } else sel.innerHTML = `<option value="${currentUser}">${currentUser}</option>`;
    });
}

function updateRecipientList() {
    db.ref('users').once('value', snap => {
        const u = snap.val() || {};
        const sel = document.getElementById('chatRecipient');
        sel.innerHTML = '<option value="all">ğŸ“¢ Ù„Ù„ÙƒÙ„</option>';
        Object.keys(u).forEach(x => { if(x !== currentUser) sel.innerHTML += `<option value="${x}">ğŸ‘¤ ${x}</option>`; });
    });
}

function printReport() { window.print(); }

async function cloudBackup() {
    const snap = await db.ref('archive').once('value');
    await db.ref('public_backup/latest').set({ data: snap.val(), at: firebase.database.ServerValue.TIMESTAMP });
    logSystem("Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ", "ØªÙ… Ø¹Ù…Ù„ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø³Ø­Ø§Ø¨ÙŠØ©");
    Swal.fire('ØªÙ…', 'Ø­ÙØ¸ Ø³Ø­Ø§Ø¨ÙŠ Ø¨Ù†Ø¬Ø§Ø­', 'success');
}

async function cloudRestore() {
    if(users[currentUser].role !== 'super' && users[currentUser].role !== 'supervisor') return;
    const snap = await db.ref('public_backup/latest').once('value');
    if(snap.val()) { 
        await db.ref('archive').set(snap.val().data); 
        logSystem("Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª", "ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø£Ø±Ø´ÙŠÙ Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©");
        loadContent(); 
        Swal.fire('ØªÙ…', 'Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­', 'success'); 
    }
}
</script>
</body>
</html>

