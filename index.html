<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>BrushManager Pro - V3.0.0 Ultimate</title>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4361ee">
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root { --primary: #4361ee; --success: #2ec4b6; --danger: #f72585; --bg: #f0f2f5; --dark: #2d3436; --warning: #ff9f43; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); margin: 0; padding: 10px; }
        .card { background: #fff; border-radius: 18px; padding: 20px; box-shadow: 0 8px 20px rgba(0,0,0,0.06); margin-bottom: 15px; }
        
        /* Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª */
        .log-container { max-height: 200px; overflow-y: auto; background: #1e272e; color: #0be881; border-radius: 10px; padding: 10px; font-family: monospace; font-size: 11px; }
        .log-row { border-bottom: 1px solid #3d3d3d; padding: 4px 0; display: flex; justify-content: space-between; }

        table { width: 100%; border-collapse: collapse; background: white; min-width: 600px; }
        th { background: var(--dark); color: white; padding: 12px; font-size: 13px; }
        td { padding: 5px; border: 1px solid #ddd; text-align: center; }
        input, select { width: 92%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; text-align: center; font-size: 14px; }
        .btn { padding: 10px 15px; border: none; border-radius: 12px; cursor: pointer; font-weight: bold; color: white; transition: 0.3s; margin: 5px; }
        
        /* Ù†Ø¸Ø§Ù… Ø§Ù„Ø´Ø§Øª */
        #chatBox { position: fixed; bottom: 20px; left: 20px; width: 340px; height: 500px; background: white; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); display: none; flex-direction: column; z-index: 1000; overflow: hidden; border: 1px solid #ddd; }
        #chatMessages { flex: 1; padding: 10px; overflow-y: auto; background: #f0f2f5; display: flex; flex-direction: column; gap: 10px; }
        .msg { max-width: 85%; padding: 10px; border-radius: 15px; font-size: 13px; position: relative; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .msg.sent { align-self: flex-end; background: var(--primary); color: white; border-bottom-right-radius: 2px; }
        .msg.received { align-self: flex-start; background: white; color: #000; border-bottom-left-radius: 2px; }
        .msg img { max-width: 100%; border-radius: 10px; margin-top: 5px; cursor: pointer; }
        .private-tag { font-size: 9px; background: var(--danger); color: white; padding: 2px 5px; border-radius: 5px; }
        .msg-actions { display: none; position: absolute; top: -25px; left: 0; background: #333; border-radius: 5px; padding: 2px 8px; gap: 10px; }
        .msg:hover .msg-actions { display: flex; }

        #chatToggle { position: fixed; bottom: 20px; left: 20px; width: 60px; height: 60px; background: var(--primary); border-radius: 50%; display: none; justify-content: center; align-items: center; color: white; font-size: 24px; cursor: pointer; z-index: 999; }

        @media print { 
            .noPrint { display: none !important; } 
            .card { box-shadow: none; border: 1px solid #000; margin: 0; padding: 10px; }
            body { background: white; }
            #printableArea { display: block !important; }
        }
    </style>
</head>
<body>

<div id="loginBox" class="card" style="max-width:400px; margin:50px auto; text-align:center;">
    <h2 style="color:var(--primary);">ğŸ›¡ï¸ BrushManager Ultimate</h2>
    <input id="username" type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…"><br><br>
    <input id="pass" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"><br><br>
    <button onclick="login()" class="btn" style="background:var(--primary); width:100%">Ø¯Ø®ÙˆÙ„ Ø¢Ù…Ù†</button>
</div>

<div id="app" style="display:none;">
    <div class="card noPrint" style="display:flex; justify-content:space-between; align-items:center;">
        <div>ğŸŸ¢ <span id="connText">Ù…ØªØµÙ„</span> | Ù…Ø±Ø­Ø¨Ø§Ù‹: <b id="welcomeUser"></b></div>
        <div>
            <button onclick="printReport()" class="btn" style="background:var(--dark)">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© PDF Ù…Ù†Ø¸Ù…</button>
            <button onclick="location.reload()" class="btn" style="background:var(--danger)">Ø®Ø±ÙˆØ¬</button>
        </div>
    </div>

    <div id="adminArea" class="noPrint" style="display:none;">
        <div class="card" style="border: 2px solid var(--warning);">
            <h4 style="margin:0 0 10px 0; color:var(--dark);">ğŸ“œ Ø³Ø¬Ù„ Ù†Ø´Ø§Ø· Ø§Ù„Ù†Ø¸Ø§Ù… (Audit Log)</h4>
            <div id="auditLogs" class="log-container"></div>
            <div style="margin-top:10px;">
                <button onclick="clearLogs()" class="btn" style="background:var(--danger); font-size:11px;">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„</button>
                <button onclick="printLogs()" class="btn" style="background:var(--primary); font-size:11px;">ğŸ“‹ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø³Ø¬Ù„</button>
            </div>
        </div>
        
        <div class="card">
            <h4 style="color:var(--danger); margin:0 0 10px 0;">ğŸ› ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</h4>
            <div style="display:flex; gap:5px; margin-bottom:15px;">
                <input id="newWorkerName" type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù">
                <input id="newWorkerPass" type="text" placeholder="Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯">
                <button onclick="addNewWorker()" class="btn" style="background:var(--success)">Ø¥Ø¶Ø§ÙØ©</button>
            </div>
            <div id="usersList"></div>
        </div>
    </div>

    <div class="card noPrint" style="display:flex; gap:10px; flex-wrap:wrap;">
        <div style="flex:1;"><label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input type="date" id="daySelect" onchange="switchContext()"></div>
        <div style="flex:1;"><label>Ø§Ù„ÙˆØ±Ø¯ÙŠØ©</label>
            <select id="shiftSelect" onchange="switchContext()">
                <option value="ÙˆØ±Ø¯ÙŠØ©_1">Ø§Ù„Ø£ÙˆÙ„Ù‰</option>
                <option value="ÙˆØ±Ø¯ÙŠØ©_2">Ø§Ù„Ø«Ø§Ù†ÙŠØ©</option>
                <option value="ÙˆØ±Ø¯ÙŠØ©_3">Ø§Ù„Ø«Ø§Ù„Ø«Ø©</option>
            </select>
        </div>
        <div style="flex:1;"><label>Ø§Ù„Ù…ÙˆØ¸Ù</label><select id="userSelect" onchange="switchContext()"></select></div>
    </div>

    <div id="printableArea" class="card">
        <div class="onlyPrint" style="text-align:center; display:none;">
            <h2>ØªÙ‚Ø±ÙŠØ± Ø¥Ù†ØªØ§Ø¬ Ù…ØµÙ†Ø¹ Ø§Ù„ÙØ±Ø´</h2>
            <p id="printInfo"></p>
        </div>
        <div style="display:flex; justify-content:space-around; margin-bottom:15px; background:var(--bg); padding:10px; border-radius:10px;">
            <div>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚Ø·Ø¹: <b id="sumTotal" style="color:var(--primary); font-size:18px;">0</b></div>
            <div>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù‚Ø§Ø³Ø§Øª: <b id="sumSizes" style="color:var(--success); font-size:18px;">0</b></div>
        </div>
        <div style="overflow-x:auto;">
            <table id="mainTable">
                <thead><tr><th>Ø§Ù„ÙØ±Ø´Ø©</th><th>Ø§Ù„Ø·Ø¨Ù‚Ø§Øª</th><th>Ø§Ù„Ù…Ù‚Ø§Ø³</th><th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th><th>Ø§Ù„Ø®Ø·</th><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th><th class="noPrint">âœ–</th></tr></thead>
                <tbody id="tbody" oninput="liveUpdate()"></tbody>
            </table>
        </div>
        <br>
        <button onclick="addRow()" class="btn noPrint" style="background:var(--success); width:100%">â• Ø¥Ø¶Ø§ÙØ© Ø³Ø·Ø± Ø¬Ø¯ÙŠØ¯</button>
    </div>

    <div class="card noPrint" style="text-align:center;">
        <button onclick="cloudBackup()" class="btn" style="background:#0984e3;">ğŸ“¤ Ø±ÙØ¹ Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ù…ØµÙ†Ø¹</button>
        <button onclick="cloudRestore()" class="btn" style="background:#6c5ce7;">ğŸ“¥ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø£Ø±Ø´ÙŠÙ</button>
    </div>
</div>

<div id="chatToggle" onclick="toggleChat()">ğŸ’¬</div>

<div id="chatBox">
    <div style="background:var(--primary); color:white; padding:12px; font-weight:bold;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <span>ğŸ’¬ Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø© Ø§Ù„Ø®Ø§ØµØ©</span>
            <span onclick="toggleChat()" style="cursor:pointer;">âœ–</span>
        </div>
        <select id="chatRecipient" style="width:100%; margin-top:5px; height:30px; font-size:11px;"></select>
    </div>
    <div id="chatMessages"></div>
    <div style="padding:10px; border-top:1px solid #eee;">
        <div style="display:flex; gap:5px; align-items:center;">
            <button onclick="document.getElementById('chatFile').click()" style="background:none; border:none; font-size:18px; cursor:pointer;">ğŸ“</button>
            <input type="file" id="chatFile" style="display:none" onchange="sendChatFile(this)">
            <input type="text" id="chatMsgInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ..." onkeypress="if(event.key==='Enter') sendChatMessage()" style="flex:1;">
            <button onclick="sendChatMessage()" style="background:var(--primary); color:white; border:none; border-radius:50%; width:35px; height:35px; cursor:pointer;">âœˆ</button>
        </div>
    </div>
</div>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyDDhfiJkDvafZQB57DA9jsF7R3iF8jokQI",
    authDomain: "brushmanager-98d94.firebaseapp.com",
    databaseURL: "https://brushmanager-98d94-default-rtdb.firebaseio.com",
    projectId: "brushmanager-98d94",
    appId: "1:319953455236:web:e7e93bf6073da63f1b1ad1"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let currentUser, activeUser, activeDay, activeShift;
let users = {};

// 1. Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ù„Ø¨Ø¯Ø¡
function login() {
    let u = document.getElementById('username').value.trim();
    let p = document.getElementById('pass').value;
    db.ref('users').once('value', snap => {
        users = snap.val() || {"admin":{"pass":"MTIz","role":"super"}};
        if (users[u] && users[u].pass === btoa(p)) {
            currentUser = activeUser = u;
            startApp();
            logSystem("ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„", "Ù…ÙˆÙÙ‚");
        } else Swal.fire('ÙØ´Ù„', 'Ø¨ÙŠØ§Ù†Ø§Øª Ø®Ø§Ø·Ø¦Ø©', 'error');
    });
}

function startApp() {
    document.getElementById('loginBox').style.display = 'none';
    document.getElementById('app').style.display = 'block';
    document.getElementById('chatToggle').style.display = 'flex';
    document.getElementById('welcomeUser').innerText = currentUser;
    
    activeDay = new Date().toISOString().split('T')[0];
    document.getElementById('daySelect').value = activeDay;
    activeShift = "ÙˆØ±Ø¯ÙŠØ©_1";
    
    if(users[currentUser].role === 'super') {
        document.getElementById('adminArea').style.display = 'block';
        listenToAudit();
        renderAdminUsers();
    }
    
    updateUserSelector();
    loadContent();
    initChat();
    updateRecipientList();
}

// 2. Ù†Ø¸Ø§Ù… Ø§Ù„Ø³Ø¬Ù„ (Audit Log)
function logSystem(action, details) {
    db.ref('system_audit').push({
        user: currentUser,
        action: action,
        details: details,
        time: new Date().toLocaleString('ar-EG'),
        timestamp: firebase.database.ServerValue.TIMESTAMP
    });
}

function listenToAudit() {
    db.ref('system_audit').limitToLast(50).on('value', snap => {
        const logs = snap.val() || {};
        document.getElementById('auditLogs').innerHTML = Object.values(logs).reverse().map(l => `
            <div class="log-row">
                <span>[${l.time}] <b>${l.user}</b></span>
                <span>${l.action}: ${l.details}</span>
            </div>
        `).join('');
    });
}

function clearLogs() {
    if(confirm('Ø³ÙŠØªÙ… Ø­Ø°Ù Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø· Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ØŒ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')) {
        db.ref('system_audit').remove();
        logSystem("Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„", "Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ø£Ø¯Ù…Ù†");
    }
}

// 3. Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
function printReport() {
    document.getElementById('printInfo').innerText = `Ø§Ù„ØªØ§Ø±ÙŠØ®: ${activeDay} | Ø§Ù„ÙˆØ±Ø¯ÙŠØ©: ${activeShift} | Ø§Ù„Ù…ÙˆØ¸Ù: ${activeUser}`;
    window.print();
    logSystem("Ø·Ø¨Ø§Ø¹Ø©", `ØªÙ‚Ø±ÙŠØ± ${activeDay}`);
}

function printLogs() {
    const content = document.getElementById('auditLogs').innerHTML;
    const win = window.open('', '', 'width=800,height=600');
    win.document.write(`<html><body style="direction:rtl; font-family:sans-serif;"><h2>Ø³Ø¬Ù„ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</h2>${content}</body></html>`);
    win.document.close();
    win.print();
}

// 4. Ø§Ù„Ø´Ø§Øª Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„ (Ù…Ø¹ Ø§Ù„Ù…Ù„ÙØ§ØªØŒ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ØŒ Ø§Ù„Ø­Ø°Ù)
function toggleChat() {
    const box = document.getElementById('chatBox');
    box.style.display = box.style.display === 'flex' ? 'none' : 'flex';
}

function initChat() {
    db.ref('chats/global').on('value', snap => {
        const msgDiv = document.getElementById('chatMessages');
        msgDiv.innerHTML = '';
        const data = snap.val() || {};
        Object.keys(data).forEach(id => {
            const m = data[id];
            if (m.to === 'all' || m.sender === currentUser || m.to === currentUser || users[currentUser].role === 'super') {
                const div = document.createElement('div');
                div.className = `msg ${m.sender === currentUser ? 'sent' : 'received'}`;
                
                let acts = m.sender === currentUser ? `<div class="msg-actions"><span onclick="editMsg('${id}','${m.text}')">âœï¸</span><span onclick="deleteMsg('${id}')">ğŸ—‘ï¸</span></div>` : '';
                let tag = m.to !== 'all' ? `<span class="private-tag">ğŸ”’ Ø®Ø§Øµ Ù„Ù€ ${m.to}</span><br>` : '';
                let file = m.file ? (m.type.includes('image') ? `<img src="${m.file}" onclick="window.open(this.src)">` : `<br><a href="${m.file}" target="_blank">ğŸ“ Ù…Ù„Ù Ù…Ø±ÙÙ‚</a>`) : '';
                
                div.innerHTML = `${acts}${tag}<b>${m.sender}:</b><br>${m.text}${file}<div style="font-size:9px; opacity:0.6; margin-top:4px;">${new Date(m.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})} ${m.edited ? '(Ù…Ø¹Ø¯Ù„Ø©)' : ''}</div>`;
                msgDiv.appendChild(div);
            }
        });
        msgDiv.scrollTop = msgDiv.scrollHeight;
    });
}

function sendChatMessage() {
    const input = document.getElementById('chatMsgInput');
    const to = document.getElementById('chatRecipient').value;
    if(!input.value.trim()) return;
    db.ref('chats/global').push({
        sender: currentUser, to: to, text: input.value, timestamp: firebase.database.ServerValue.TIMESTAMP
    });
    input.value = '';
}

function sendChatFile(input) {
    const file = input.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
        db.ref('chats/global').push({
            sender: currentUser, to: document.getElementById('chatRecipient').value,
            text: `Ø£Ø±Ø³Ù„ Ù…Ù„ÙØ§Ù‹: ${file.name}`, file: e.target.result, type: file.type, timestamp: firebase.database.ServerValue.TIMESTAMP
        });
    };
    reader.readAsDataURL(file);
}

function deleteMsg(id) { if(confirm('Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø©ØŸ')) db.ref(`chats/global/${id}`).remove(); }
async function editMsg(id, old) {
    const { value: text } = await Swal.fire({ title: 'ØªØ¹Ø¯ÙŠÙ„', input: 'text', inputValue: old, showCancelButton: true });
    if(text) db.ref(`chats/global/${id}`).update({ text: text, edited: true });
}

// 5. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø¯ÙˆÙ† ØªØºÙŠÙŠØ±)
function liveUpdate() {
    let tp = 0, ts = 0;
    document.querySelectorAll('#tbody tr').forEach(row => {
        let l = parseFloat(row.cells[1].querySelector('input').value) || 0;
        let s = parseFloat(row.cells[2].querySelector('input').value) || 0;
        let r = l * s;
        row.cells[3].innerText = r.toFixed(0);
        tp += r; ts += s;
    });
    document.getElementById('sumTotal').innerText = tp.toFixed(0);
    document.getElementById('sumSizes').innerText = ts.toFixed(1);
    clearTimeout(window.saveT);
    window.saveT = setTimeout(saveData, 1500);
}

function addRow(d = {name:'', l:0, s:0, line:1, note:''}) {
    const r = document.getElementById('tbody').insertRow();
    r.innerHTML = `
        <td><input type="text" value="${d.name}"></td>
        <td><input type="number" value="${d.l}"></td>
        <td><input type="number" value="${d.s}"></td>
        <td style="font-weight:bold;">0</td>
        <td><input type="text" value="${d.line}"></td>
        <td><input type="text" value="${d.note}"></td>
        <td class="noPrint"><button onclick="this.closest('tr').remove(); liveUpdate();" style="color:red; background:none; border:none; font-size:18px;">âœ–</button></td>`;
    liveUpdate();
}

function saveData() {
    if (currentUser !== activeUser && users[currentUser].role !== 'super') return;
    let data = [];
    document.querySelectorAll('#tbody tr').forEach(row => {
        const name = row.cells[0].querySelector('input').value;
        if(name.trim() !== "") {
            data.push({ name, l: row.cells[1].querySelector('input').value, s: row.cells[2].querySelector('input').value, line: row.cells[4].querySelector('input').value, note: row.cells[5].querySelector('input').value });
        }
    });
    db.ref(`archive/${activeDay}/${activeShift}/${activeUser}`).set(data);
    localStorage.setItem(`offline_${activeDay}_${activeShift}_${activeUser}`, JSON.stringify(data));
}

function loadContent() {
    document.getElementById('tbody').innerHTML = '';
    db.ref(`archive/${activeDay}/${activeShift}/${activeUser}`).once('value', snap => {
        let data = snap.val() || JSON.parse(localStorage.getItem(`offline_${activeDay}_${activeShift}_${activeUser}`) || '[]');
        if(data && data.length > 0) data.forEach(item => addRow(item));
        else addRow();
    });
}

function switchContext() {
    activeUser = document.getElementById('userSelect').value;
    activeDay = document.getElementById('daySelect').value;
    activeShift = document.getElementById('shiftSelect').value;
    loadContent();
}

async function cloudBackup() {
    Swal.fire({ title: 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...', didOpen: () => Swal.showLoading() });
    const snap = await db.ref('archive').once('value');
    await db.ref('public_backup/latest').set({ data: snap.val(), by: currentUser, at: firebase.database.ServerValue.TIMESTAMP });
    Swal.fire('ØªÙ…', 'ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ', 'success');
    logSystem("Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ", "Ø³Ø­Ø§Ø¨ÙŠ");
}

async function cloudRestore() {
    const snap = await db.ref('public_backup/latest').once('value');
    if(!snap.val()) return;
    if(confirm('Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø£Ø±Ø´ÙŠÙØŸ Ø³ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©')) {
        await db.ref('archive').update(snap.val().data);
        loadContent();
        logSystem("Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª", "Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨");
    }
}

// 6. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ÙˆØ§Ù„Ù‚ÙˆØ§Ø¦Ù…
function renderAdminUsers() {
    db.ref('users').on('value', snap => {
        const all = snap.val() || {};
        document.getElementById('usersList').innerHTML = Object.keys(all).filter(u => all[u].role !== 'super').map(u => `
            <div style="display:flex; justify-content:space-between; padding:8px; border-bottom:1px solid #eee;">
                <span>ğŸ‘¤ <b>${u}</b></span>
                <button onclick="deleteWorker('${u}')" style="color:red; border:none; background:none; cursor:pointer;">âœ– Ø­Ø°Ù</button>
            </div>
        `).join('');
    });
}

function addNewWorker() {
    const n = document.getElementById('newWorkerName').value.trim();
    const p = document.getElementById('newWorkerPass').value.trim();
    if(n && p) {
        db.ref(`users/${n}`).set({ pass: btoa(p), role: 'user' });
        logSystem("Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù", n);
    }
}

function deleteWorker(n) { if(confirm(`Ø­Ø°Ù ${n}ØŸ`)) { db.ref(`users/${n}`).remove(); logSystem("Ø­Ø°Ù Ù…ÙˆØ¸Ù", n); } }

function updateUserSelector() {
    const sel = document.getElementById('userSelect');
    db.ref('users').once('value', snap => {
        const u = snap.val() || {};
        if(users[currentUser].role === 'super') {
            sel.innerHTML = Object.keys(u).map(x => `<option value="${x}" ${x===currentUser?'selected':''}>${x}</option>`).join('');
        } else sel.innerHTML = `<option value="${currentUser}">${currentUser}</option>`;
    });
}

function updateRecipientList() {
    db.ref('users').once('value', snap => {
        const u = snap.val() || {};
        const sel = document.getElementById('chatRecipient');
        sel.innerHTML = '<option value="all">ğŸ“¢ Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„ÙƒÙ„ (Ø¹Ø§Ù…)</option>';
        Object.keys(u).forEach(x => { if(x !== currentUser) sel.innerHTML += `<option value="${x}">ğŸ‘¤ Ø®Ø§Øµ Ù„Ù€: ${x}</option>`; });
    });
}
</script>
</body>
</html>
